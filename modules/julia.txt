RUN echo "en_US.UTF-8 UTF-8" > /etc/locale.gen && locale-gen

RUN aptitude update
RUN aptitude install -y build-essential libmagickwand-6.q16-2 python3 python3-dev python3-pip julia bzip2 ca-certificates sudo locales
RUN pip3 install --upgrade pip
RUN pip3 install jsonschema jinja2 tornado pyzmq ipython jupyter

# Configure environment

ENV SHELL /bin/bash
ENV NB_USER developer
ENV NB_UID 1000
ENV HOME /home/$NB_USER
ENV LC_ALL en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US.UTF-8

RUN useradd -m -s /bin/bash -N -u $NB_UID $NB_USER && chown -R $NB_USER $HOME

USER $NB_USER

# Setup developer home directory

RUN mkdir /home/$NB_USER/work && \
    mkdir /home/$NB_USER/.jupyter && \
    mkdir -p -m 700 /home/$NB_USER/.local/share/jupyter && \
    echo "cacert=/etc/ssl/certs/ca-certificates.crt" > /home/$NB_USER/.curlrc

# Julia misc

RUN echo "#!/bin/bash" > ~/ijulia.sh
RUN echo "jupyter notebook --no-browser --certfile=~/.jupyter/mycert.pem --keyfile=~/.jupyter/mykey.key" >> ~/ijulia.sh
RUN chmod +x ~/ijulia.sh

RUN julia -e 'Pkg.add("Images")'
RUN julia -e 'Pkg.add("ImageMagick")'
RUN julia -e 'Pkg.add("IJulia")'
RUN julia -e 'Pkg.build("IJulia")'

# Finals

USER root

COPY jupyter_notebook_config.py /home/$NB_USER/.jupyter/
COPY mycert.pem /home/$NB_USER/.jupyter/
COPY mykey.key /home/$NB_USER/.jupyter/

EXPOSE 9999
WORKDIR /home/$NB_USER/work

RUN apt-get clean && rm -rf /var/lib/apt/lists/*

USER $NB_USER
